<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Guitar Sight-Reading Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vexflow/releases/vexflow-min.js"></script>
    <style>
        /* Custom Piano Styles */
        .piano-key {
            transition: background-color 0.1s;
            border-bottom-left-radius: 4px;
            border-bottom-right-radius: 4px;
        }
        .piano-key.white {
            height: 120px;
            z-index: 1;
            background: white;
            border: 1px solid #ccc;
        }
        .piano-key.black {
            height: 80px;
            z-index: 2;
            background: #333;
            margin-left: -12px;
            margin-right: -12px;
            width: 24px;
            position: relative;
        }
        .piano-key.active {
            background-color: #3b82f6 !important; /* Blue-500 */
            box-shadow: 0 0 10px #3b82f6;
        }
        
        /* Custom Fretboard Styles */
        .string-line {
            position: absolute;
            height: 2px;
            background: #9ca3af;
            left: 0;
            right: 0;
            transform: translateY(-50%);
            pointer-events: none;
        }
        .fret-wire {
            position: absolute;
            width: 2px;
            background: #d1d5db;
            top: 0;
            bottom: 0;
            pointer-events: none;
        }
        .fret-marker {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            transition: all 0.1s;
        }
        .fret-cell:hover .fret-marker {
            background-color: #e5e7eb;
        }
        .fret-cell.active .fret-marker {
            background-color: #3b82f6;
            box-shadow: 0 0 8px #3b82f6;
        }
        .nut {
            border-right: 4px solid #4b5563;
        }

        /* Staff Interaction Overlay */
        .staff-click-zone {
            transition: background-color 0.1s;
            cursor: pointer;
        }
        .staff-click-zone:hover {
            background-color: rgba(59, 130, 246, 0.1);
        }

        /* Prevent text selection */
        body {
            user-select: none;
            -webkit-user-select: none;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col items-center">

    <!-- Header -->
    <header class="w-full bg-white shadow-sm p-4 text-center sticky top-0 z-50">
        <h1 class="text-xl font-bold text-slate-700">Guitar Practice Tool</h1>
        <div id="note-display" class="text-3xl font-extrabold text-blue-600 mt-1 h-10 flex items-center justify-center">
            Tap Start
        </div>
        <button id="start-btn" class="mt-2 bg-blue-600 text-white px-6 py-2 rounded-full font-semibold shadow hover:bg-blue-700 transition">
            Start Audio
        </button>
    </header>

    <main class="w-full max-w-3xl flex-1 flex flex-col p-2 gap-4 pb-8">
        
        <!-- SECTION 1: Standard Notation & Tab (VexFlow) -->
        <div class="bg-white rounded-xl shadow p-2 flex flex-col items-center relative overflow-hidden">
            <h2 class="text-xs uppercase tracking-wider text-slate-400 font-bold mb-1 w-full text-left">Notation & Tab</h2>
            
            <!-- VexFlow Container -->
            <div id="vexflow-container" class="w-full flex justify-center"></div>

            <!-- Invisible Click Overlay for Staff -->
            <!-- We will generate clickable divs overlaying the staff area to allow "clicking standard notation" -->
            <div id="staff-overlay" class="absolute top-10 left-0 w-full h-[120px] flex justify-center z-10 opacity-0 hover:opacity-100 transition-opacity">
                <!-- Zones will be injected by JS -->
            </div>
        </div>

        <!-- SECTION 2: Interactive Fretboard -->
        <div class="bg-white rounded-xl shadow p-3">
            <h2 class="text-xs uppercase tracking-wider text-slate-400 font-bold mb-2">Guitar Fretboard (First Position)</h2>
            <div class="relative w-full overflow-x-auto">
                <div id="fretboard" class="min-w-[300px] select-none">
                    <!-- Fretboard generated by JS -->
                </div>
            </div>
            <div class="flex justify-between text-xs text-slate-400 mt-1 px-2">
                <span>Open</span>
                <span>Fret 1</span>
                <span>Fret 2</span>
                <span>Fret 3</span>
                <span>Fret 4</span>
                <span>Fret 5</span>
            </div>
        </div>

        <!-- SECTION 3: Piano -->
        <div class="bg-white rounded-xl shadow p-3 pb-6">
            <h2 class="text-xs uppercase tracking-wider text-slate-400 font-bold mb-2">Keyboard</h2>
            <div class="relative h-[140px] flex justify-center select-none overflow-x-auto overflow-y-hidden">
                <div id="piano" class="flex relative h-full px-4">
                    <!-- Piano keys generated by JS -->
                </div>
            </div>
        </div>

    </main>

    <script>
        // --- DATA & CONFIGURATION ---

        // Range: E2 (MIDI 40) to A4 (MIDI 69) - Typical First Position Range
        const NOTE_DATA = [];
        const STRINGS = [64, 59, 55, 50, 45, 40]; // MIDI numbers for open strings (High E to Low E)
        const STRING_NAMES = ['E', 'B', 'G', 'D', 'A', 'E'];
        
        // Helper to get note name
        const NOTES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        
        function getNoteInfo(midi) {
            const noteIndex = midi % 12;
            const octave = Math.floor(midi / 12) - 1;
            const name = NOTES[noteIndex];
            return { name, octave, midi, fullName: `${name}${octave}` };
        }

        // Generate Map for First Position (Frets 0-5)
        // We prioritize open strings and low frets.
        function findGuitarPosition(midi) {
            // Check strings from High E (1) to Low E (6)
            // String 1 is index 0 in our logic arrays, index 1 physically
            for (let s = 0; s < 6; s++) {
                const openStrMidi = STRINGS[s];
                const fret = midi - openStrMidi;
                if (fret >= 0 && fret <= 5) {
                    return { string: s + 1, fret: fret }; // String 1-6
                }
            }
            return null; // Out of range
        }

        // Initialize Data Range
        for (let m = 40; m <= 69; m++) {
            const info = getNoteInfo(m);
            const pos = findGuitarPosition(m);
            if (pos) {
                // VexFlow keys format: "c/4"
                const vfKey = `${info.name.toLowerCase()}/${info.octave}`; 
                NOTE_DATA[m] = {
                    ...info,
                    ...pos,
                    vfKey: vfKey
                };
            }
        }

        let currentMidi = 40; // Start at Low E
        let audioCtx = null;
        let isAudioStarted = false;

        // --- AUDIO ENGINE ---
        
        function initAudio() {
            if (!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
            }
        }

        function playTone(midi) {
            if (!audioCtx) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();

            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();

            // Calculate frequency: f = 440 * 2^((d-69)/12)
            const freq = 440 * Math.pow(2, (midi - 69) / 12);
            
            osc.type = 'triangle'; // Softer, more instrument-like than sine
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            
            // Envelope
            gain.gain.setValueAtTime(0, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0.3, audioCtx.currentTime + 0.05); // Attack
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 1.5); // Decay

            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            osc.start();
            osc.stop(audioCtx.currentTime + 1.5);
        }

        // --- VEXFLOW RENDERER ---

        const { Renderer, Stave, StaveNote, TabStave, TabNote, Formatter, Voice } = Vex.Flow;
        let vfRenderer, vfContext;

        function initVexFlow() {
            const div = document.getElementById("vexflow-container");
            div.innerHTML = ""; // Clear
            vfRenderer = new Renderer(div, Renderer.Backends.SVG);
            
            // Responsive width
            const width = Math.min(window.innerWidth - 40, 500);
            vfRenderer.resize(width, 220); // Height covers both staves
            vfContext = vfRenderer.getContext();
            vfContext.scale(width / 400, width / 400); // Scale logic for mobile
        }

        function renderNote(midi) {
            if (!vfContext) initVexFlow();
            vfContext.clear();
            
            const data = NOTE_DATA[midi];
            if (!data) return;

            // 1. Standard Notation Stave
            const stave = new Stave(10, 0, 300);
            stave.addClef("treble");
            stave.setContext(vfContext).draw();

            // 2. Tab Stave
            const tabStave = new TabStave(10, 100, 300);
            tabStave.addClef("tab");
            tabStave.setContext(vfContext).draw();

            // Notes
            // We must handle accidentals (sharps) manually for VexFlow keys
            const key = data.vfKey;
            const accidental = key.includes('#') ? '#' : null;

            const note = new StaveNote({
                keys: [key],
                duration: "w",
                clef: "treble"
            });

            if (accidental) note.addModifier(new Vex.Flow.Accidental(accidental));

            const tabNote = new TabNote({
                positions: [{ str: data.string, fret: data.fret }],
                duration: "w"
            });

            // Voices & Format
            const voice = new Voice({num_beats: 4, beat_value: 4});
            voice.addTickables([note]);
            
            const tabVoice = new Voice({num_beats: 4, beat_value: 4});
            tabVoice.addTickables([tabNote]);

            new Formatter().joinVoices([voice]).format([voice], 250);
            new Formatter().joinVoices([tabVoice]).format([tabVoice], 250);

            voice.draw(vfContext, stave);
            tabVoice.draw(vfContext, tabStave);
        }

        // --- UI GENERATORS ---

        function buildFretboard() {
            const container = document.getElementById('fretboard');
            container.innerHTML = '';
            
            // Create 6 string rows
            for (let s = 0; s < 6; s++) { // 0 is String 1 (High E) in logic
                const stringRow = document.createElement('div');
                stringRow.className = "relative h-10 flex w-full";
                
                // Draw the string line
                const line = document.createElement('div');
                line.className = "string-line";
                // String thickness variation
                line.style.height = (s * 0.5 + 1) + 'px'; 
                line.style.top = "50%";
                stringRow.appendChild(line);

                // Create Frets 0-5
                for (let f = 0; f <= 5; f++) {
                    const cell = document.createElement('div');
                    // Styles
                    let classes = "fret-cell flex-1 relative flex items-center justify-center cursor-pointer ";
                    if (f === 0) classes += "nut border-r-4 border-slate-600 bg-slate-100 ";
                    else classes += "border-r border-slate-300 ";
                    
                    cell.className = classes;
                    cell.dataset.string = s + 1;
                    cell.dataset.fret = f;
                    
                    // Interaction
                    cell.onclick = () => selectNoteByStringFret(s, f);

                    // Marker (The Dot)
                    const marker = document.createElement('div');
                    marker.className = "fret-marker rounded-full opacity-50";
                    marker.id = `fret-${s}-${f}`; // Unique ID for highlighting
                    
                    // Show note name hint small? No, keep clean.
                    
                    cell.appendChild(marker);
                    stringRow.appendChild(cell);
                }
                container.appendChild(stringRow);
            }
        }

        function buildPiano() {
            const container = document.getElementById('piano');
            container.innerHTML = '';

            // Range E2 (40) to A4 (69)
            // We need to render keys properly. 
            // White keys are flex items. Black keys are absolute positioned overlays between white keys.
            
            // Logic: Iterate MIDI notes. If white, add div. If black, append to previous white key wrapper or handle positioning.
            // Simpler Logic: Render all White keys in flow. Render Black keys absolutely relative to the container?
            // Robust Logic: Use a wrapper for every white key. If a black key follows, put it in the wrapper (or absolute).
            
            // Let's iterate chromatic, but build visual structure.
            // We iterate from 40 to 69.
            
            for (let m = 40; m <= 69; m++) {
                const info = getNoteInfo(m);
                const isBlack = info.name.includes('#');
                
                const keyDiv = document.createElement('div');
                keyDiv.id = `key-${m}`;
                keyDiv.dataset.midi = m;
                keyDiv.onclick = (e) => {
                    e.stopPropagation();
                    updateState(m);
                };

                if (isBlack) {
                    keyDiv.className = "piano-key black cursor-pointer";
                } else {
                    keyDiv.className = "piano-key white flex-1 cursor-pointer";
                }
                container.appendChild(keyDiv);
            }
        }

        function buildStaffOverlay() {
            const overlay = document.getElementById('staff-overlay');
            overlay.innerHTML = '';
            
            // We want clickable zones for the staff.
            // E2 is low. A4 is high.
            // Approximate height mapping. The VexFlow stave is drawn roughly in the middle.
            // We'll create simple buttons for "Note Selection" mapped to height?
            // Actually, a simpler way to fulfill "Click Standard Notation" is to just map vertical bars 
            // corresponding to natural notes, and maybe small toggles for sharps? 
            // Given the complexity of "clicking a space" for a specific note (C vs C#), 
            // I will create a transparent grid of bars where height = pitch.
            
            // We will map only Natural notes to click zones (C, D, E...) 
            // This is a simplification for the "Click Notation" requirement. 
            // Clicking "E" toggles E natural. 
            
            // Let's construct zones for White Keys (Natural Notes) from E2 to A4.
            // Display them flex-col-reverse (High notes top).
            const container = document.createElement('div');
            container.className = "flex flex-col-reverse h-full w-[200px] bg-transparent";
            
            // Filter naturals
            const naturals = [];
            for(let m=40; m<=69; m++) {
                if(!NOTE_DATA[m].name.includes('#')) naturals.push(m);
            }

            naturals.forEach(m => {
                const zone = document.createElement('div');
                zone.className = "flex-1 w-full staff-click-zone border-t border-transparent hover:border-blue-200";
                zone.title = NOTE_DATA[m].fullName;
                zone.onclick = () => updateState(m);
                container.appendChild(zone);
            });
            overlay.appendChild(container);
        }

        // --- STATE MANAGEMENT ---

        function updateState(midi) {
            // Validate range
            if (midi < 40 || midi > 69) return;
            if (!NOTE_DATA[midi]) return;

            currentMidi = midi;
            const data = NOTE_DATA[midi];

            // 1. Audio
            if(isAudioStarted) playTone(midi);

            // 2. Header Text
            document.getElementById('note-display').textContent = `${data.name} ${data.octave}`;

            // 3. VexFlow
            renderNote(midi);

            // 4. Highlight Fretboard
            // Clear all
            document.querySelectorAll('.fret-cell').forEach(el => el.classList.remove('active'));
            // Find specific fret
            // Note: data.string is 1-based index (1=High E). Our loop s=0 is High E.
            // data.string 1 (High E) -> row index 0.
            const rowIdx = data.string - 1; 
            const fretId = `fret-${rowIdx}-${data.fret}`;
            const marker = document.getElementById(fretId);
            if(marker) {
                marker.parentElement.classList.add('active');
            }

            // 5. Highlight Piano
            document.querySelectorAll('.piano-key').forEach(el => el.classList.remove('active'));
            const key = document.getElementById(`key-${midi}`);
            if(key) key.classList.add('active');
        }

        function selectNoteByStringFret(sIndex, fret) {
            // sIndex 0 = High E (MIDI 64 open)
            const openMidi = STRINGS[sIndex];
            const targetMidi = openMidi + fret;
            updateState(targetMidi);
        }

        // --- INITIALIZATION ---

        window.onload = () => {
            buildFretboard();
            buildPiano();
            buildStaffOverlay();
            
            // Handle Start
            const startBtn = document.getElementById('start-btn');
            const display = document.getElementById('note-display');

            startBtn.addEventListener('click', () => {
                initAudio();
                if (audioCtx.state === 'suspended') {
                    audioCtx.resume();
                }
                isAudioStarted = true;
                startBtn.classList.add('hidden');
                display.textContent = "Ready!";
                
                // Initial Note
                updateState(40); // E2
            });

            // Initial Render (Visuals only, no sound)
            renderNote(40); 
            // Highlight E2 manually without sound
            const key = document.getElementById(`key-40`);
            if(key) key.classList.add('active');
            const fret = document.getElementById(`fret-5-0`);
            if(fret) fret.parentElement.classList.add('active');
            document.getElementById('note-display').textContent = "E 2";
            
            // Handle Resize
            window.addEventListener('resize', () => {
                initVexFlow();
                renderNote(currentMidi);
            });
        };

    </script>
</body>
</html>

