<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Guitar Sight-Reading Coach</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/vexflow@4.2.2/build/cjs/vexflow.js"></script>
    <style>
        /* --- Layout & Utilities --- */
        body {
            overscroll-behavior: none;
            touch-action: manipulation;
            overflow: hidden; /* Prevent global scroll */
        }
        
        /* --- Piano Styling --- */
        .piano-wrapper {
            position: relative;
            width: 100%;
            height: 120px;
            display: flex;
        }
        .white-key {
            flex: 1;
            height: 100%;
            background: white;
            border: 1px solid #94a3b8;
            border-bottom-left-radius: 6px;
            border-bottom-right-radius: 6px;
            z-index: 1;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 8px;
            font-weight: bold;
            color: #cbd5e1;
            cursor: pointer;
            font-size: 14px;
            user-select: none;
        }
        .white-key.active {
            background: #3b82f6 !important;
            color: white;
            box-shadow: inset 0 -4px 0 #1d4ed8;
        }
        .white-key.disabled {
            background: #f1f5f9;
            color: #e2e8f0;
            pointer-events: none;
        }
        .black-key {
            position: absolute;
            top: 0;
            height: 60%;
            width: 10%; 
            background: #1e293b;
            z-index: 10;
            border-bottom-left-radius: 4px;
            border-bottom-right-radius: 4px;
            cursor: pointer;
            box-shadow: 2px 2px 2px rgba(0,0,0,0.2);
        }
        .black-key.active {
            background: #2563eb !important;
            box-shadow: 0 0 10px #2563eb;
        }
        .black-key.disabled {
            background: #cbd5e1;
            pointer-events: none;
        }
        
        /* Key Positioning */
        .bk-cs { left: 10%; } .bk-ds { left: 24.5%; } 
        .bk-fs { left: 53%; } .bk-gs { left: 67.5%; } .bk-as { left: 81.5%; }

        /* --- Fretboard Styling --- */
        .string-line {
            position: absolute;
            left: 0; right: 0; top: 50%;
            background: #94a3b8;
            pointer-events: none;
            box-shadow: 0 1px 1px rgba(0,0,0,0.2);
        }
        .fret-cell {
            position: relative;
            border-right: 1px solid #cbd5e1;
            cursor: pointer;
            /* Flex basis will handle width */
        }
        .nut {
            background-color: #f1f5f9;
            border-right: 4px solid #475569;
        }
        .fret-marker {
            width: 16px; height: 16px;
            border-radius: 50%;
            margin: auto;
            transition: transform 0.1s;
        }
        .fret-cell.active .fret-marker {
            background-color: #3b82f6;
            box-shadow: 0 0 8px #3b82f6;
            transform: scale(1.3);
        }

        /* Octave Selector */
        .oct-btn {
            transition: all 0.2s;
        }
        .oct-btn.selected {
            background-color: #3b82f6;
            color: white;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen w-full flex flex-col overflow-hidden">

    <!-- START OVERLAY -->
    <div id="start-overlay" class="fixed inset-0 bg-slate-900/95 z-[100] flex flex-col items-center justify-center p-6 text-center">
        <h1 class="text-3xl font-black text-white mb-2 tracking-tight">GUITAR COACH</h1>
        <p class="text-slate-400 mb-8">Sight reading & fretboard visualization</p>
        <button id="start-btn" class="bg-blue-600 text-white text-xl py-4 px-12 rounded-full font-bold shadow-lg hover:bg-blue-500 transition active:scale-95">
            TAP TO START
        </button>
        <div id="loading-status" class="mt-6 text-xs text-slate-500 font-mono">Loading Notation Engine...</div>
    </div>

    <!-- 1. NOTATION SECTION (Fixed flex ratio) -->
    <section class="flex-[4] bg-white w-full flex flex-col relative shadow-md z-10 min-h-0">
        <!-- Header -->
        <div class="absolute top-0 left-0 w-full p-2 flex justify-between items-start z-20 pointer-events-none">
            <span class="text-[10px] font-bold uppercase text-slate-400 bg-white/80 px-2 rounded backdrop-blur">Standard & Tab</span>
            <div id="note-display" class="bg-blue-600 text-white px-3 py-1 rounded-lg shadow font-bold text-xl min-w-[50px] text-center pointer-events-auto">
                E
            </div>
        </div>

        <!-- VexFlow Container -->
        <div id="vexflow-wrapper" class="w-full h-full flex items-center justify-center overflow-hidden p-2">
            <div id="vexflow-container" class="w-full h-full flex justify-center items-center"></div>
        </div>
        
        <!-- Fallback -->
        <div id="notation-fallback" class="hidden absolute inset-0 flex items-center justify-center bg-slate-50">
            <div class="text-center">
                <div class="text-6xl font-serif mb-2" id="fallback-char">ùÖù</div>
                <div class="text-xs text-slate-400">Notation unavailable</div>
            </div>
        </div>
    </section>

    <!-- 2. CONTROL TABS -->
    <div class="flex-none bg-slate-100 p-1 flex gap-1 border-b border-slate-200">
        <button onclick="switchTab('guitar')" id="tab-guitar" class="flex-1 py-2 rounded text-xs uppercase font-bold tracking-wider transition-colors bg-white text-blue-600 shadow-sm">
            Fretboard
        </button>
        <button onclick="switchTab('piano')" id="tab-piano" class="flex-1 py-2 rounded text-xs uppercase font-bold tracking-wider transition-colors text-slate-500 hover:bg-white/50">
            Keyboard
        </button>
    </div>

    <!-- 3. INPUT SECTION (Fills remaining space) -->
    <section class="flex-[5] bg-slate-50 relative overflow-hidden p-2 min-h-0">
        
        <!-- VIEW A: Fretboard -->
        <div id="view-guitar" class="w-full h-full flex flex-col justify-center items-center">
            <div class="w-full bg-white rounded-xl shadow-sm border border-slate-200 px-1 py-2 flex flex-col justify-center h-full max-h-[260px]">
                
                <!-- The Fretboard Grid -->
                <div id="fretboard" class="w-full flex-1 flex flex-col justify-between select-none">
                    <!-- JS Injected -->
                </div>
                
                <!-- Fret Labels -->
                <div class="flex text-[8px] uppercase text-slate-400 pt-1 font-bold">
                    <div style="flex: 0 0 12%; text-align: center;">Open</div>
                    <div class="flex-1 text-center">I</div>
                    <div class="flex-1 text-center">II</div>
                    <div class="flex-1 text-center">III</div>
                    <div class="flex-1 text-center">IV</div>
                    <div class="flex-1 text-center">V</div>
                </div>
            </div>
        </div>

        <!-- VIEW B: Piano -->
        <div id="view-piano" class="hidden w-full h-full flex flex-col justify-start items-center pt-2">
            
            <!-- Octave Selector -->
            <div class="flex bg-white rounded-lg p-1 shadow-sm border border-slate-200 mb-4 gap-1">
                <button class="oct-btn px-4 py-2 rounded text-sm text-slate-500 font-medium" id="oct-2" onclick="setOctave(2)">Octave 2</button>
                <button class="oct-btn px-4 py-2 rounded text-sm text-slate-500 font-medium" id="oct-3" onclick="setOctave(3)">Octave 3</button>
                <button class="oct-btn px-4 py-2 rounded text-sm text-slate-500 font-medium" id="oct-4" onclick="setOctave(4)">Octave 4</button>
            </div>

            <!-- Piano Keys -->
            <div class="w-full max-w-[380px] bg-white rounded-xl shadow-sm border border-slate-200 p-2 select-none">
                <div class="piano-wrapper">
                    <div class="white-key" id="pk-0" onclick="handlePianoInput(0)">C</div>
                    <div class="white-key" id="pk-2" onclick="handlePianoInput(2)">D</div>
                    <div class="white-key" id="pk-4" onclick="handlePianoInput(4)">E</div>
                    <div class="white-key" id="pk-5" onclick="handlePianoInput(5)">F</div>
                    <div class="white-key" id="pk-7" onclick="handlePianoInput(7)">G</div>
                    <div class="white-key" id="pk-9" onclick="handlePianoInput(9)">A</div>
                    <div class="white-key" id="pk-11" onclick="handlePianoInput(11)">B</div>
                    
                    <div class="black-key bk-cs" id="pk-1" onclick="handlePianoInput(1)"></div>
                    <div class="black-key bk-ds" id="pk-3" onclick="handlePianoInput(3)"></div>
                    <div class="black-key bk-fs" id="pk-6" onclick="handlePianoInput(6)"></div>
                    <div class="black-key bk-gs" id="pk-8" onclick="handlePianoInput(8)"></div>
                    <div class="black-key bk-as" id="pk-10" onclick="handlePianoInput(10)"></div>
                </div>
            </div>
            
            <p id="range-warning" class="text-xs text-red-400 mt-2 opacity-0 transition-opacity font-bold">Note out of guitar range</p>
        </div>

    </section>

    <script>
        // --- CONSTANTS ---
        const STRINGS = [64, 59, 55, 50, 45, 40]; // High E -> Low E
        const NOTE_NAMES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const MIN_MIDI = 40; // E2
        const MAX_MIDI = 69; // A4 (5th fret high E string)
        
        // --- STATE ---
        let currentMidi = 40; 
        let currentOctave = 2; // Default for E2
        let audioCtx = null;

        // --- UI LOGIC ---

        function switchTab(tab) {
            const guitarView = document.getElementById('view-guitar');
            const pianoView = document.getElementById('view-piano');
            const guitarBtn = document.getElementById('tab-guitar');
            const pianoBtn = document.getElementById('tab-piano');

            if (tab === 'guitar') {
                guitarView.classList.remove('hidden');
                pianoView.classList.add('hidden');
                guitarBtn.className = "flex-1 py-2 rounded text-xs uppercase font-bold tracking-wider transition-colors bg-white text-blue-600 shadow-sm";
                pianoBtn.className = "flex-1 py-2 rounded text-xs uppercase font-bold tracking-wider transition-colors text-slate-500 hover:bg-white/50";
            } else {
                guitarView.classList.add('hidden');
                pianoView.classList.remove('hidden');
                pianoBtn.className = "flex-1 py-2 rounded text-xs uppercase font-bold tracking-wider transition-colors bg-white text-blue-600 shadow-sm";
                guitarBtn.className = "flex-1 py-2 rounded text-xs uppercase font-bold tracking-wider transition-colors text-slate-500 hover:bg-white/50";
            }
        }

        function setOctave(oct) {
            currentOctave = oct;
            updateOctaveUI();
            updatePianoKeyAvailability();
        }

        function updateOctaveUI() {
            // Reset buttons
            [2,3,4].forEach(o => {
                const btn = document.getElementById(`oct-${o}`);
                if (o === currentOctave) btn.classList.add('selected');
                else btn.classList.remove('selected');
            });
        }

        // --- AUDIO ENGINE ---

        function initAudio() {
            if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if(audioCtx.state === 'suspended') audioCtx.resume();
        }

        function playTone(midi) {
            if(!audioCtx) return;
            initAudio();
            
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            osc.frequency.value = 440 * Math.pow(2, (midi - 69) / 12);
            osc.type = 'triangle';
            
            const now = audioCtx.currentTime;
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(0.3, now + 0.02);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 1.2);
            
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start(now);
            osc.stop(now + 1.5);
        }

        // --- VEXFLOW ENGINE ---

        function renderNotation(midi) {
            const container = document.getElementById('vexflow-container');
            const fallback = document.getElementById('notation-fallback');
            const pos = getGuitarPos(midi);
            const info = getNoteInfo(midi);

            if(typeof Vex === 'undefined') {
                container.style.display = 'none';
                fallback.classList.remove('hidden');
                return;
            } else {
                container.style.display = 'block';
                fallback.classList.add('hidden');
            }

            container.innerHTML = "";
            
            try {
                const { Renderer, Stave, StaveNote, TabStave, TabNote, Formatter, Voice, Accidental } = Vex.Flow;
                
                // FIXED DIMENSIONS FOR SCALING
                // We define a "virtual canvas" where we know everything fits perfectly.
                // 320px wide, 250px high.
                const baseW = 320;
                const baseH = 250; 

                const renderer = new Renderer(container, Renderer.Backends.SVG);
                renderer.resize(baseW, baseH);
                const ctx = renderer.getContext();
                
                // Center the staves in the virtual box
                // Stave width 260 leaves 30px margin on sides
                const staveWidth = 260;
                const x = (baseW - staveWidth) / 2;
                
                // Vertical spacing
                // UPDATED: Standard stave at y=10 (was 30), Tab stave at y=110 (was 130)
                // This shifts everything UP by 20px to prevent bottom clipping
                const stave = new Stave(x, 10, staveWidth);
                stave.addClef("treble");
                stave.setContext(ctx).draw();
                
                const tabStave = new TabStave(x, 110, staveWidth);
                tabStave.addClef("tab");
                tabStave.setContext(ctx).draw();

                // Notes
                const writtenOctave = info.octave + 1; 
                const vfKey = `${info.name.toLowerCase()}/${writtenOctave}`;
                
                const note = new StaveNote({
                    keys: [vfKey],
                    duration: "w",
                    clef: "treble",
                    align_center: true
                });

                if(info.isSharp) note.addModifier(new Accidental("#"));
                
                const tabNote = new TabNote({
                    positions: [{ str: pos.str + 1, fret: pos.fret }],
                    duration: "w",
                    align_center: true
                });

                const voice = new Voice({num_beats: 4, beat_value: 4});
                voice.addTickables([note]);
                
                const tabVoice = new Voice({num_beats: 4, beat_value: 4});
                tabVoice.addTickables([tabNote]);

                new Formatter().joinVoices([voice]).format([voice], staveWidth - 50);
                new Formatter().joinVoices([tabVoice]).format([tabVoice], staveWidth - 50);

                voice.draw(ctx, stave);
                tabVoice.draw(ctx, tabStave);

                // RESPONSIVE SCALING MAGIC
                // Set viewBox to the base dimensions so CSS can scale it
                const svg = container.querySelector('svg');
                if (svg) {
                    svg.setAttribute('viewBox', `0 0 ${baseW} ${baseH}`);
                    svg.style.width = '100%';
                    svg.style.height = '100%';
                    svg.style.maxHeight = '100%'; // Ensure it respects container height
                }

            } catch(e) {
                console.error("Render fail", e);
            }
        }

        // --- FRETBOARD & DATA ---

        function getNoteInfo(midi) {
            return {
                midi: midi,
                pitchClass: midi % 12,
                octave: Math.floor(midi / 12) - 1,
                name: NOTE_NAMES[midi % 12],
                isSharp: NOTE_NAMES[midi % 12].includes('#')
            };
        }

        function getGuitarPos(midi) {
            for(let s=0; s<6; s++) {
                let open = STRINGS[s];
                let fret = midi - open;
                if(fret >= 0 && fret <= 5) return { str: s, fret: fret };
            }
            return null;
        }

        function buildFretboard() {
            const fb = document.getElementById('fretboard');
            fb.innerHTML = '';

            for(let s=0; s<6; s++) {
                const row = document.createElement('div');
                // Use flex grow to fill height evenly
                row.className = "flex w-full relative items-center flex-1"; 
                
                // String Line
                const line = document.createElement('div');
                line.className = "string-line";
                line.style.height = (s * 0.5 + 1) + "px";
                row.appendChild(line);

                for(let f=0; f<=5; f++) {
                    const cell = document.createElement('div');
                    // Width logic: Nut is approx 12%, others equal flex
                    let cls = "fret-cell h-full flex items-center justify-center ";
                    if(f===0) {
                        cls += "nut";
                        cell.style.flex = "0 0 12%"; // Fixed % width for nut
                    } else {
                        cell.style.flex = "1";
                    }
                    cell.className = cls;

                    const midi = STRINGS[s] + f;
                    cell.onclick = () => updateState(midi, true);
                    cell.id = `fret-cell-${s}-${f}`;

                    const marker = document.createElement('div');
                    marker.className = "fret-marker";
                    cell.appendChild(marker);
                    row.appendChild(cell);
                }
                fb.appendChild(row);
            }
        }

        // --- MAIN LOGIC ---

        function updateState(midi, playSound = true) {
            if (midi < MIN_MIDI || midi > MAX_MIDI) {
                showRangeWarning();
                return;
            }

            currentMidi = midi;
            const info = getNoteInfo(midi);
            const pos = getGuitarPos(midi);

            // Audio
            if(playSound) playTone(midi);

            // Update State Vars
            currentOctave = info.octave;
            updateOctaveUI();
            updatePianoKeyAvailability();

            // Text
            document.getElementById('note-display').innerText = info.name;

            // Notation
            renderNotation(midi);

            // Fretboard Highlight
            document.querySelectorAll('.fret-cell').forEach(c => c.classList.remove('active'));
            if(pos) {
                const activeCell = document.getElementById(`fret-cell-${pos.str}-${pos.fret}`);
                if(activeCell) activeCell.classList.add('active');
            }

            // Piano Highlight
            document.querySelectorAll('.white-key, .black-key').forEach(k => k.classList.remove('active'));
            const activeKey = document.getElementById(`pk-${info.pitchClass}`);
            if(activeKey) activeKey.classList.add('active');
        }

        // Handle Piano Input (Pitch Class + Current Octave)
        function handlePianoInput(pitchClass) {
            const targetMidi = (currentOctave + 1) * 12 + pitchClass;
            updateState(targetMidi, true);
        }

        // Visual feedback for keys that are out of range for the *current* octave
        function updatePianoKeyAvailability() {
            // Check all 12 pitch classes for the current octave
            for (let pc = 0; pc < 12; pc++) {
                const midi = (currentOctave + 1) * 12 + pc;
                const el = document.getElementById(`pk-${pc}`);
                
                if (midi < MIN_MIDI || midi > MAX_MIDI) {
                    el.classList.add('disabled');
                    el.style.opacity = '0.5';
                } else {
                    el.classList.remove('disabled');
                    el.style.opacity = '1';
                }
            }
        }

        function showRangeWarning() {
            const w = document.getElementById('range-warning');
            w.style.opacity = '1';
            setTimeout(() => w.style.opacity = '0', 1000);
        }

        // --- INIT ---

        window.onload = function() {
            buildFretboard();
            setOctave(2); // Start at lowest octave

            // Check Library
            const status = document.getElementById('loading-status');
            const intv = setInterval(() => {
                if(typeof Vex !== 'undefined') {
                    clearInterval(intv);
                    status.innerText = "Ready!";
                    status.className = "mt-6 text-xs text-green-400 font-bold uppercase";
                    updateState(40, false);
                }
            }, 200);

            document.getElementById('start-btn').onclick = function() {
                initAudio();
                document.getElementById('start-overlay').style.display = 'none';
                updateState(currentMidi, true);
            };

            let resizeTimer;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(() => {
                    renderNotation(currentMidi);
                }, 200);
            });
        };
    </script>
</body>
</html>
