<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Guitar Sight-Reading Coach</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/vexflow@4.2.2/build/cjs/vexflow.js"></script>
    <style>
        /* --- Layout & Utilities --- */
        body {
            overscroll-behavior: none;
            touch-action: manipulation;
        }
        
        /* --- Piano Styling --- */
        .piano-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
        }
        .white-key {
            flex: 1;
            height: 100%;
            background: white;
            border: 1px solid #94a3b8;
            border-bottom-left-radius: 6px;
            border-bottom-right-radius: 6px;
            z-index: 1;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 10px;
            font-weight: bold;
            color: #cbd5e1;
            cursor: pointer;
            font-size: 14px;
        }
        .white-key.active {
            background: #3b82f6 !important;
            color: white;
            box-shadow: inset 0 -4px 0 #1d4ed8;
        }
        .black-key {
            position: absolute;
            top: 0;
            height: 60%;
            width: 10%; /* Relative width */
            background: #1e293b;
            z-index: 10;
            border-bottom-left-radius: 4px;
            border-bottom-right-radius: 4px;
            cursor: pointer;
            box-shadow: 2px 2px 2px rgba(0,0,0,0.2);
        }
        .black-key.active {
            background: #2563eb !important;
            box-shadow: 0 0 10px #2563eb;
        }
        
        /* Percentage-based positioning for 7 white keys */
        /* Each white key is ~14.28% width */
        .bk-cs { left: 10%; }  /* Between 1st and 2nd */
        .bk-ds { left: 24.5%; } /* Between 2nd and 3rd */
        .bk-fs { left: 53%; }   /* Between 4th and 5th */
        .bk-gs { left: 67.5%; } /* Between 5th and 6th */
        .bk-as { left: 81.5%; } /* Between 6th and 7th */

        /* --- Fretboard Styling --- */
        .string-line {
            position: absolute;
            left: 0; right: 0; top: 50%;
            background: #94a3b8;
            pointer-events: none;
            box-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        .fret-cell {
            position: relative;
            border-right: 1px solid #cbd5e1;
            cursor: pointer;
        }
        .nut {
            background-color: #f1f5f9;
            border-right: 4px solid #475569;
        }
        .fret-marker {
            width: 18px; height: 18px;
            border-radius: 50%;
            margin: auto;
            transition: transform 0.1s;
        }
        .fret-cell.active .fret-marker {
            background-color: #3b82f6;
            box-shadow: 0 0 8px #3b82f6;
            transform: scale(1.2);
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen w-full flex flex-col overflow-hidden">

    <!-- START OVERLAY -->
    <div id="start-overlay" class="fixed inset-0 bg-slate-900/95 z-[100] flex flex-col items-center justify-center p-6 text-center">
        <h1 class="text-3xl font-black text-white mb-2 tracking-tight">GUITAR COACH</h1>
        <p class="text-slate-400 mb-8">Sight reading & fretboard visualization</p>
        <button id="start-btn" class="bg-blue-600 text-white text-xl py-4 px-12 rounded-full font-bold shadow-lg hover:bg-blue-500 transition active:scale-95">
            TAP TO START
        </button>
        <div id="loading-status" class="mt-6 text-xs text-slate-500 font-mono">Loading Notation Engine...</div>
    </div>

    <!-- 1. TOP SECTION: NOTATION (Fixed Height) -->
    <!-- We give this about 45% of the vertical space -->
    <section class="h-[45%] bg-white w-full flex flex-col relative shadow-md z-10">
        
        <!-- Header Strip -->
        <div class="absolute top-0 left-0 w-full p-2 flex justify-between items-start z-20 pointer-events-none">
            <span class="text-[10px] font-bold uppercase text-slate-400 bg-white/80 px-2 rounded">Standard & Tab</span>
            <!-- Current Note Display -->
            <div id="note-display" class="bg-blue-600 text-white px-3 py-1 rounded-lg shadow font-bold text-xl min-w-[50px] text-center pointer-events-auto">
                E
            </div>
        </div>

        <!-- VexFlow Container -->
        <div id="vexflow-wrapper" class="w-full h-full flex items-center justify-center overflow-hidden">
            <div id="vexflow-container"></div>
        </div>
        
        <!-- Fallback if VexFlow fails -->
        <div id="notation-fallback" class="hidden absolute inset-0 flex items-center justify-center bg-slate-50">
            <div class="text-center">
                <div class="text-6xl font-serif mb-2" id="fallback-char">ùÖù</div>
                <div class="text-xs text-slate-400">Notation unavailable</div>
            </div>
        </div>
    </section>

    <!-- 2. MIDDLE CONTROL BAR (Tabs) -->
    <div class="flex-none bg-slate-100 p-1 flex gap-1 border-b border-slate-200">
        <button onclick="switchTab('guitar')" id="tab-guitar" class="flex-1 py-2 rounded text-sm font-bold transition-colors bg-white text-blue-600 shadow-sm">
            FRETBOARD
        </button>
        <button onclick="switchTab('piano')" id="tab-piano" class="flex-1 py-2 rounded text-sm font-bold transition-colors text-slate-500 hover:bg-white/50">
            KEYBOARD
        </button>
    </div>

    <!-- 3. BOTTOM SECTION: INPUT (Fills remaining space) -->
    <section class="flex-1 bg-slate-50 relative overflow-hidden p-2">
        
        <!-- VIEW A: Fretboard -->
        <div id="view-guitar" class="w-full h-full flex flex-col justify-center">
            <div class="w-full bg-white rounded-xl shadow-sm border border-slate-200 p-1 py-4 overflow-x-auto">
                <div id="fretboard" class="min-w-[340px] select-none">
                    <!-- JS Injected -->
                </div>
                <!-- Fret Labels -->
                <div class="flex text-[9px] uppercase text-slate-400 mt-2 font-bold px-1">
                    <div style="width: 46px;" class="text-center">Open</div>
                    <div class="flex-1 text-center">I</div>
                    <div class="flex-1 text-center">II</div>
                    <div class="flex-1 text-center">III</div>
                    <div class="flex-1 text-center">IV</div>
                    <div class="flex-1 text-center">V</div>
                </div>
            </div>
            <p class="text-[10px] text-center text-slate-400 mt-2">Tap any string/fret to play</p>
        </div>

        <!-- VIEW B: Piano -->
        <div id="view-piano" class="hidden w-full h-full flex flex-col justify-center items-center pb-4">
            <div class="w-full max-w-[360px] h-[160px] bg-white rounded-xl shadow-sm border border-slate-200 p-2 select-none">
                <div class="piano-wrapper">
                    <!-- White Keys -->
                    <div class="white-key" id="pk-0" onclick="handlePianoInput(0)">C</div>
                    <div class="white-key" id="pk-2" onclick="handlePianoInput(2)">D</div>
                    <div class="white-key" id="pk-4" onclick="handlePianoInput(4)">E</div>
                    <div class="white-key" id="pk-5" onclick="handlePianoInput(5)">F</div>
                    <div class="white-key" id="pk-7" onclick="handlePianoInput(7)">G</div>
                    <div class="white-key" id="pk-9" onclick="handlePianoInput(9)">A</div>
                    <div class="white-key" id="pk-11" onclick="handlePianoInput(11)">B</div>
                    
                    <!-- Black Keys -->
                    <div class="black-key bk-cs" id="pk-1" onclick="handlePianoInput(1)"></div>
                    <div class="black-key bk-ds" id="pk-3" onclick="handlePianoInput(3)"></div>
                    <div class="black-key bk-fs" id="pk-6" onclick="handlePianoInput(6)"></div>
                    <div class="black-key bk-gs" id="pk-8" onclick="handlePianoInput(8)"></div>
                    <div class="black-key bk-as" id="pk-10" onclick="handlePianoInput(10)"></div>
                </div>
            </div>
            <p class="text-[10px] text-center text-slate-400 mt-4">Pitch Class (Plays lowest available note)</p>
        </div>

    </section>

    <script>
        // --- CONSTANTS ---
        const STRINGS = [64, 59, 55, 50, 45, 40]; // High E -> Low E
        const NOTE_NAMES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        let currentMidi = 40; 
        let audioCtx = null;

        // --- UI LOGIC ---

        function switchTab(tab) {
            const guitarView = document.getElementById('view-guitar');
            const pianoView = document.getElementById('view-piano');
            const guitarBtn = document.getElementById('tab-guitar');
            const pianoBtn = document.getElementById('tab-piano');

            if (tab === 'guitar') {
                guitarView.classList.remove('hidden');
                pianoView.classList.add('hidden');
                guitarBtn.classList.add('bg-white', 'text-blue-600', 'shadow-sm');
                guitarBtn.classList.remove('text-slate-500');
                pianoBtn.classList.remove('bg-white', 'text-blue-600', 'shadow-sm');
                pianoBtn.classList.add('text-slate-500');
            } else {
                guitarView.classList.add('hidden');
                pianoView.classList.remove('hidden');
                pianoBtn.classList.add('bg-white', 'text-blue-600', 'shadow-sm');
                pianoBtn.classList.remove('text-slate-500');
                guitarBtn.classList.remove('bg-white', 'text-blue-600', 'shadow-sm');
                guitarBtn.classList.add('text-slate-500');
            }
        }

        // --- DATA HELPERS ---

        function getNoteInfo(midi) {
            return {
                midi: midi,
                pitchClass: midi % 12,
                octave: Math.floor(midi / 12) - 1,
                name: NOTE_NAMES[midi % 12],
                isSharp: NOTE_NAMES[midi % 12].includes('#')
            };
        }

        // Find Guitar Position (Prefer lower frets/open strings)
        function getGuitarPos(midi) {
            for(let s=0; s<6; s++) {
                let open = STRINGS[s];
                let fret = midi - open;
                if(fret >= 0 && fret <= 5) return { str: s, fret: fret };
            }
            return null;
        }

        // --- AUDIO ENGINE ---

        function initAudio() {
            if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if(audioCtx.state === 'suspended') audioCtx.resume();
        }

        function playTone(midi) {
            if(!audioCtx) return;
            initAudio();
            
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            // Freq calculation
            osc.frequency.value = 440 * Math.pow(2, (midi - 69) / 12);
            osc.type = 'triangle'; // Clear tone
            
            const now = audioCtx.currentTime;
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(0.4, now + 0.02);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 1.2);
            
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start(now);
            osc.stop(now + 1.5);
        }

        // --- VEXFLOW ENGINE ---

        function renderNotation(midi) {
            const container = document.getElementById('vexflow-container');
            const fallback = document.getElementById('notation-fallback');
            const pos = getGuitarPos(midi);
            const info = getNoteInfo(midi);

            // Library Check
            if(typeof Vex === 'undefined') {
                container.style.display = 'none';
                fallback.classList.remove('hidden');
                return;
            } else {
                container.style.display = 'block';
                fallback.classList.add('hidden');
            }

            container.innerHTML = "";
            
            try {
                const { Renderer, Stave, StaveNote, TabStave, TabNote, Formatter, Voice, Accidental } = Vex.Flow;
                
                // Use wrapper dimensions
                const wrapper = document.getElementById('vexflow-wrapper');
                const w = wrapper.clientWidth;
                const h = wrapper.clientHeight;

                const renderer = new Renderer(container, Renderer.Backends.SVG);
                renderer.resize(w, h);
                const ctx = renderer.getContext();
                
                // Centering math
                const staveWidth = 260;
                const x = (w - staveWidth) / 2;
                const yStandard = (h / 2) - 100; // Position staff in upper middle
                const yTab = (h / 2) + 10;       // Position tab below it

                // 1. Standard Stave
                const stave = new Stave(x, yStandard, staveWidth);
                stave.addClef("treble");
                stave.setContext(ctx).draw();
                
                // 2. Tab Stave
                const tabStave = new TabStave(x, yTab, staveWidth);
                tabStave.addClef("tab");
                tabStave.setContext(ctx).draw();

                // 3. Notes
                // GUITAR TRANSPOSITION LOGIC:
                // Guitar sounds 1 octave lower than written.
                // If actual audio pitch is E2 (midi 40), we write E3 on staff.
                // VexFlow key format: "e/3"
                const writtenOctave = info.octave + 1; 
                const vfKey = `${info.name.toLowerCase()}/${writtenOctave}`;
                
                const note = new StaveNote({
                    keys: [vfKey],
                    duration: "w",
                    clef: "treble",
                    align_center: true
                });

                if(info.isSharp) note.addModifier(new Accidental("#"));
                
                // VexFlow strings are 1-based (1=High E)
                const tabNote = new TabNote({
                    positions: [{ str: pos.str + 1, fret: pos.fret }],
                    duration: "w",
                    align_center: true
                });

                // 4. Draw
                const voice = new Voice({num_beats: 4, beat_value: 4});
                voice.addTickables([note]);
                
                const tabVoice = new Voice({num_beats: 4, beat_value: 4});
                tabVoice.addTickables([tabNote]);

                new Formatter().joinVoices([voice]).format([voice], staveWidth - 50);
                new Formatter().joinVoices([tabVoice]).format([tabVoice], staveWidth - 50);

                voice.draw(ctx, stave);
                tabVoice.draw(ctx, tabStave);

            } catch(e) {
                console.error("Render fail", e);
            }
        }

        // --- FRETBOARD BUILDER ---

        function buildFretboard() {
            const fb = document.getElementById('fretboard');
            fb.innerHTML = '';

            for(let s=0; s<6; s++) {
                const row = document.createElement('div');
                row.className = "flex w-full relative h-10 items-center"; // Taller touch target
                
                // String visual
                const line = document.createElement('div');
                line.className = "string-line";
                line.style.height = (s * 0.5 + 1) + "px"; // Thicker low strings
                row.appendChild(line);

                for(let f=0; f<=5; f++) {
                    const cell = document.createElement('div');
                    let cls = "fret-cell flex-1 h-full flex items-center justify-center ";
                    if(f===0) cls += "nut flex-none w-[46px] ";
                    cell.className = cls;

                    const midi = STRINGS[s] + f;
                    cell.onclick = () => updateState(midi, true);
                    cell.id = `fret-cell-${s}-${f}`;

                    const marker = document.createElement('div');
                    marker.className = "fret-marker";
                    cell.appendChild(marker);
                    row.appendChild(cell);
                }
                fb.appendChild(row);
            }
        }

        // --- MAIN LOGIC ---

        function updateState(midi, playSound = true) {
            currentMidi = midi;
            const pos = getGuitarPos(midi);
            const info = getNoteInfo(midi);

            if(!pos) return;

            // Audio
            if(playSound) playTone(midi);

            // Display
            document.getElementById('note-display').innerText = info.name;

            // Render
            renderNotation(midi);

            // Highlights - Fretboard
            document.querySelectorAll('.fret-cell').forEach(c => c.classList.remove('active'));
            const activeCell = document.getElementById(`fret-cell-${pos.str}-${pos.fret}`);
            if(activeCell) activeCell.classList.add('active');

            // Highlights - Piano
            document.querySelectorAll('.white-key, .black-key').forEach(k => k.classList.remove('active'));
            const activeKey = document.getElementById(`pk-${info.pitchClass}`);
            if(activeKey) activeKey.classList.add('active');
        }

        function handlePianoInput(pitchClass) {
            // Find lowest valid MIDI note for this pitch class on guitar
            // Range 40 -> 69 (approx)
            let target = -1;
            for(let m=40; m<=69; m++) {
                if(m % 12 === pitchClass) {
                    target = m;
                    break;
                }
            }
            if(target !== -1) updateState(target, true);
        }

        // --- INIT ---

        window.onload = function() {
            buildFretboard();
            
            // Wait for library
            const status = document.getElementById('loading-status');
            let checks = 0;
            const intv = setInterval(() => {
                checks++;
                if(typeof Vex !== 'undefined') {
                    clearInterval(intv);
                    status.innerText = "Ready!";
                    status.className = "mt-6 text-xs text-green-400 font-bold uppercase";
                    // Initial render (no sound)
                    updateState(40, false);
                } else if(checks > 20) {
                    clearInterval(intv);
                    status.innerText = "Notation not loaded (Check Connection)";
                    status.className = "mt-6 text-xs text-red-400";
                }
            }, 200);

            // Start Handler
            document.getElementById('start-btn').onclick = function() {
                initAudio();
                document.getElementById('start-overlay').style.display = 'none';
                updateState(currentMidi, true);
            };

            // Resize Handler for VexFlow
            let resizeTimer;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(() => {
                    renderNotation(currentMidi);
                }, 200);
            });
        };
    </script>
</body>
</html>

