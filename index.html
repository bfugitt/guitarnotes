<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Guitar Sight-Reading Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Updated, stable VexFlow source -->
    <script src="https://unpkg.com/vexflow@4.2.3/build/vexflow.js"></script>
    <style>
        /* Custom Piano Styles */
        .piano-key {
            transition: background-color 0.1s, transform 0.05s;
            border-bottom-left-radius: 4px;
            border-bottom-right-radius: 4px;
        }
        .piano-key:active {
            transform: scale(0.98);
        }
        .piano-key.white {
            height: 120px;
            z-index: 1;
            background: white;
            border: 1px solid #94a3b8; /* Slate-400 */
        }
        .piano-key.black {
            height: 75px;
            z-index: 2;
            background: #1e293b; /* Slate-800 */
            margin-left: -12px;
            margin-right: -12px;
            width: 26px;
            position: relative;
            border: 1px solid #0f172a;
        }
        .piano-key.active {
            background-color: #3b82f6 !important; /* Blue-500 */
            box-shadow: 0 0 10px #3b82f6;
            border-color: #2563eb;
        }
        
        /* Fretboard Styles */
        .string-line {
            position: absolute;
            height: 2px;
            background: #9ca3af;
            left: 0;
            right: 0;
            transform: translateY(-50%);
            pointer-events: none;
            box-shadow: 0 1px 1px rgba(0,0,0,0.2);
        }
        .fret-wire {
            position: absolute;
            width: 2px;
            background: #d1d5db;
            top: 0;
            bottom: 0;
            pointer-events: none;
        }
        .fret-marker {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            transition: all 0.1s;
        }
        .fret-cell:hover .fret-marker {
            background-color: #f3f4f6;
        }
        .fret-cell.active .fret-marker {
            background-color: #3b82f6;
            box-shadow: 0 0 8px #3b82f6;
        }
        .nut {
            border-right: 5px solid #374151; /* Darker nut */
        }

        /* Overlay for clicking the staff area */
        .staff-touch-zone {
            /* Debug: background: rgba(255, 0, 0, 0.1); */
        }

        body {
            user-select: none;
            -webkit-user-select: none; /* iOS Safari */
            touch-action: manipulation;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 min-h-screen flex flex-col items-center font-sans">

    <!-- Header -->
    <header class="w-full bg-white shadow-md p-4 text-center sticky top-0 z-50">
        <h1 class="text-lg font-bold text-slate-700 uppercase tracking-wide">Sight Reading Coach</h1>
        
        <!-- Status / Note Display -->
        <div id="note-display" class="text-4xl font-black text-blue-600 my-2 h-12 flex items-center justify-center tracking-tight">
            <!-- Populated by JS -->
        </div>

        <!-- Start Button Overlay -->
        <div id="start-overlay" class="fixed inset-0 bg-slate-900/80 z-[60] flex flex-col items-center justify-center p-6 backdrop-blur-sm">
            <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center">
                <h2 class="text-2xl font-bold mb-2 text-slate-800">Ready to Practice?</h2>
                <p class="text-slate-500 mb-6">Tap start to enable audio.</p>
                <button id="start-btn" class="w-full bg-blue-600 text-white text-lg py-4 rounded-xl font-bold shadow-lg hover:bg-blue-700 active:scale-95 transition-all">
                    Start Audio
                </button>
                <p id="loading-msg" class="mt-4 text-sm text-amber-600 hidden">Loading notation engine...</p>
            </div>
        </div>
    </header>

    <main class="w-full max-w-3xl flex-1 flex flex-col p-3 gap-4 pb-12">
        
        <!-- 1. NOTATION & TAB -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-2 flex flex-col items-center relative overflow-hidden">
            <div class="w-full flex justify-between items-center px-2 mb-1">
                <h2 class="text-xs uppercase tracking-wider text-slate-400 font-bold">Standard & Tab</h2>
            </div>
            
            <!-- VexFlow Container -->
            <div id="vexflow-container" class="w-full flex justify-center bg-white min-h-[220px]"></div>

            <!-- Invisible Click Zones -->
            <div id="staff-overlay" class="absolute inset-0 z-10 flex flex-col pointer-events-none">
                <!-- Zones injected by JS -->
            </div>
        </div>

        <!-- 2. FRETBOARD -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
            <h2 class="text-xs uppercase tracking-wider text-slate-400 font-bold mb-3">Guitar (First Position)</h2>
            <div class="relative w-full overflow-x-auto pb-2">
                <div id="fretboard" class="min-w-[340px] select-none pl-2">
                    <!-- Fretboard injected by JS -->
                </div>
            </div>
            <!-- Fret Numbers -->
            <div class="flex justify-between text-[10px] uppercase text-slate-400 mt-2 px-4 font-bold tracking-widest">
                <span>Open</span>
                <span>I</span>
                <span>II</span>
                <span>III</span>
                <span>IV</span>
                <span>V</span>
            </div>
        </div>

        <!-- 3. PIANO -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 pb-6">
            <h2 class="text-xs uppercase tracking-wider text-slate-400 font-bold mb-2">Piano Reference</h2>
            <div class="relative h-[130px] flex justify-center select-none overflow-x-auto overflow-y-hidden">
                <div id="piano" class="flex relative h-full px-2">
                    <!-- Piano keys injected by JS -->
                </div>
            </div>
        </div>

    </main>

    <script>
        /**
         * GUITAR SIGHT READING APP
         * Handles Audio, VexFlow Notation, and Logic Mapping
         */

        // --- CONSTANTS ---
        const STRINGS = [64, 59, 55, 50, 45, 40]; // High E (MIDI 64) to Low E (MIDI 40)
        const NOTES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        // Range: Low E (40) to High A (69) on 1st string 5th fret
        const MIN_MIDI = 40;
        const MAX_MIDI = 69;

        // Global State
        let currentMidi = 40;
        let audioCtx = null;
        let vfContext = null;
        let vfRenderer = null;

        // --- DATA STRUCTURES ---
        
        // Precompute note data for performance
        const NOTE_MAP = {};

        function initData() {
            for (let m = MIN_MIDI; m <= MAX_MIDI; m++) {
                const noteIndex = m % 12;
                const octave = Math.floor(m / 12) - 1;
                const name = NOTES[noteIndex];
                const isBlack = name.includes('#');
                
                // Find Guitar Position (First Position Priority)
                let guitarPos = null;
                // Check from string 1 (High E) down to string 6
                for (let s = 0; s < 6; s++) {
                    const openMidi = STRINGS[s];
                    const fret = m - openMidi;
                    if (fret >= 0 && fret <= 5) {
                        guitarPos = { string: s + 1, fret: fret }; // String is 1-based for VexFlow
                        break; // Stop at first valid position (preferred)
                    }
                }

                if (guitarPos) {
                    NOTE_MAP[m] = {
                        midi: m,
                        name: name,
                        octave: octave,
                        fullName: `${name}${octave}`,
                        isBlack: isBlack,
                        guitar: guitarPos,
                        vfKey: `${name.toLowerCase()}/${octave}`
                    };
                }
            }
        }

        // --- AUDIO ENGINE ---

        function initAudio() {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
            } catch (e) {
                console.error("Web Audio API not supported", e);
                alert("Sorry, audio is not supported on this browser.");
            }
        }

        function playTone(midi) {
            if (!audioCtx) return;
            
            // Auto-resume if suspended (common browser policy)
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }

            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();

            // Frequency formula
            const freq = 440 * Math.pow(2, (midi - 69) / 12);
            
            osc.type = 'triangle'; // Clear, distinguishable tone
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);

            // Volume Envelope (ADSR-ish)
            const now = audioCtx.currentTime;
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(0.4, now + 0.02); // Quick attack
            gain.gain.exponentialRampToValueAtTime(0.001, now + 1.0); // Long decay

            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            osc.start(now);
            osc.stop(now + 1.0);
        }

        // --- VEXFLOW RENDERER ---

        function renderVexFlow(midi) {
            const div = document.getElementById("vexflow-container");
            const data = NOTE_MAP[midi];
            if (!data) return;

            // Clear previous
            div.innerHTML = "";

            // Wait for VexFlow to load
            if (typeof Vex === 'undefined') {
                div.innerHTML = "<div class='text-red-500 mt-10'>Library Loading...</div>";
                return;
            }

            const { Renderer, Stave, StaveNote, TabStave, TabNote, Formatter, Voice, Accidental } = Vex.Flow;

            // Setup Renderer
            // Scale based on screen width
            const width = div.clientWidth > 0 ? div.clientWidth : 350;
            const renderer = new Renderer(div, Renderer.Backends.SVG);
            renderer.resize(width, 220);
            const context = renderer.getContext();
            
            // Center the stave visually by adding padding
            const xOffset = (width - 250) / 2;

            // 1. Treble Clef Stave
            const stave = new Stave(xOffset, 0, 250);
            stave.addClef("treble");
            stave.setContext(context).draw();

            // 2. Tab Stave
            const tabStave = new TabStave(xOffset, 100, 250);
            tabStave.addClef("tab");
            tabStave.setContext(context).draw();

            // Note Logic
            // Handle sharps
            const noteKey = data.vfKey;
            const hasSharp = data.name.includes('#');

            const note = new StaveNote({
                keys: [noteKey],
                duration: "w",
                clef: "treble",
                align_center: true
            });

            if (hasSharp) {
                note.addModifier(new Accidental("#"));
            }

            // Tab Note Logic
            const tabNote = new TabNote({
                positions: [{ str: data.guitar.string, fret: data.guitar.fret }],
                duration: "w",
                align_center: true
            });

            // Voices
            const voice = new Voice({num_beats: 4, beat_value: 4});
            voice.addTickables([note]);
            
            const tabVoice = new Voice({num_beats: 4, beat_value: 4});
            tabVoice.addTickables([tabNote]);

            // Format and Draw
            new Formatter().joinVoices([voice]).format([voice], 200);
            new Formatter().joinVoices([tabVoice]).format([tabVoice], 200);

            voice.draw(context, stave);
            tabVoice.draw(context, tabStave);
        }

        // --- UI BUILDERS ---

        function buildFretboard() {
            const container = document.getElementById('fretboard');
            container.innerHTML = '';
            
            // 6 Strings
            for (let s = 0; s < 6; s++) { // s=0 is High E (visual top)
                const row = document.createElement('div');
                row.className = "relative h-10 flex w-full";
                
                // Visual String Line
                const line = document.createElement('div');
                line.className = "string-line";
                line.style.height = (s * 0.6 + 1) + "px"; // Thicker for low strings
                line.style.top = "50%";
                row.appendChild(line);

                // Frets 0-5
                for (let f = 0; f <= 5; f++) {
                    const cell = document.createElement('div');
                    let baseClass = "fret-cell flex-1 relative flex items-center justify-center cursor-pointer active:bg-slate-100 ";
                    
                    if (f === 0) {
                        baseClass += "nut border-r-4 border-slate-600 bg-slate-50 ";
                        cell.style.flex = "0 0 50px"; // Nut is narrower
                    } else {
                        baseClass += "border-r border-slate-300 ";
                    }
                    
                    cell.className = baseClass;
                    
                    // Logic to find MIDI
                    const stringMidiStart = STRINGS[s];
                    const cellMidi = stringMidiStart + f;
                    
                    cell.onclick = () => updateState(cellMidi);

                    // Marker Dot
                    const marker = document.createElement('div');
                    marker.className = "fret-marker opacity-40";
                    marker.id = `fret-${s}-${f}`; // ID for targeting

                    // Fret Inlay Dots (Single dot on fret 3 and 5)
                    if (f === 3 || f === 5) {
                         if (s === 2 || s === 3) {
                             // Not actual dots, just logic, but we keep it simple
                         }
                    }

                    cell.appendChild(marker);
                    row.appendChild(cell);
                }
                container.appendChild(row);
            }
        }

        function buildPiano() {
            const container = document.getElementById('piano');
            container.innerHTML = '';

            for (let m = MIN_MIDI; m <= MAX_MIDI; m++) {
                if (!NOTE_MAP[m]) continue;
                
                const { isBlack } = NOTE_MAP[m];
                
                const key = document.createElement('div');
                key.id = `key-${m}`;
                key.onclick = (e) => { e.stopPropagation(); updateState(m); };
                
                if (isBlack) {
                    key.className = "piano-key black cursor-pointer shadow-md";
                } else {
                    key.className = "piano-key white flex-1 cursor-pointer shadow-sm rounded-b";
                }
                
                container.appendChild(key);
            }
        }

        function buildStaffClickZones() {
            // Create a transparent overlay that roughly maps height to pitch
            // This allows users to "click the staff" roughly where a note is.
            const overlay = document.getElementById('staff-overlay');
            
            // We'll make vertical bands for specific target notes (naturals)
            // Just a simple column of clickable divs
            
            const zoneContainer = document.createElement('div');
            zoneContainer.className = "absolute top-[10px] left-0 right-0 h-[200px] flex flex-col-reverse pointer-events-auto z-20";
            zoneContainer.style.width = "60%"; // Center it
            zoneContainer.style.left = "20%";

            // Filter naturals in range
            const targets = [];
            for (let m = MIN_MIDI; m <= MAX_MIDI; m++) {
                if (!NOTE_MAP[m].isBlack) targets.push(m);
            }

            targets.forEach(m => {
                const zone = document.createElement('div');
                zone.className = "flex-1 w-full cursor-pointer hover:bg-blue-500/10 transition-colors";
                zone.onclick = () => updateState(m);
                zoneContainer.appendChild(zone);
            });

            overlay.appendChild(zoneContainer);
        }

        // --- STATE MANAGEMENT ---

        function updateState(midi) {
            if (midi < MIN_MIDI || midi > MAX_MIDI) return;
            
            currentMidi = midi;
            const data = NOTE_MAP[midi];

            // 1. Play Sound (if started)
            if (audioCtx) playTone(midi);

            // 2. Update Text
            const display = document.getElementById('note-display');
            display.textContent = `${data.name.replace('#', 'â™¯')} ${data.octave}`;

            // 3. Render Notation
            // Small delay to ensure container size is correct if resizing
            requestAnimationFrame(() => renderVexFlow(midi));

            // 4. Update Fretboard UI
            document.querySelectorAll('.fret-cell').forEach(el => el.classList.remove('active'));
            // Fret logic: data.guitar.string is 1-based. Loop s is 0-based.
            const sIdx = data.guitar.string - 1;
            const fIdx = data.guitar.fret;
            const fretMarker = document.getElementById(`fret-${sIdx}-${fIdx}`);
            if (fretMarker) {
                fretMarker.parentElement.classList.add('active');
            }

            // 5. Update Piano UI
            document.querySelectorAll('.piano-key').forEach(el => el.classList.remove('active'));
            const pianoKey = document.getElementById(`key-${midi}`);
            if (pianoKey) {
                pianoKey.classList.add('active');
            }
        }

        // --- INIT SEQUENCE ---

        window.onload = function() {
            initData();
            buildFretboard();
            buildPiano();
            buildStaffClickZones();

            const startBtn = document.getElementById('start-btn');
            const overlay = document.getElementById('start-overlay');
            const loadMsg = document.getElementById('loading-msg');

            // Check if VexFlow loaded
            if (typeof Vex === 'undefined') {
                loadMsg.classList.remove('hidden');
                // Poll for library
                const checkVex = setInterval(() => {
                    if (typeof Vex !== 'undefined') {
                        clearInterval(checkVex);
                        loadMsg.textContent = "Engine Ready";
                        loadMsg.className = "text-green-600 mt-4 text-sm font-bold";
                        // Initial Render behind overlay
                        updateState(40);
                    }
                }, 500);
            } else {
                updateState(40); // E2 Start
            }

            // Unlock Audio on Click
            startBtn.addEventListener('click', () => {
                initAudio();
                if (audioCtx) {
                    audioCtx.resume().then(() => {
                        overlay.classList.add('hidden'); // Hide overlay
                        updateState(currentMidi); // Re-trigger to confirm sound
                    });
                } else {
                    // Fallback if audio fails but we want to let them use it
                    overlay.classList.add('hidden');
                }
            });

            // Resize Handler
            let resizeTimer;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(() => {
                    renderVexFlow(currentMidi);
                }, 100);
            });
        };

    </script>
</body>
</html>

